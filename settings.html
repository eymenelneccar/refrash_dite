<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>الإعدادات العامة | iqr menu BACKOFFICE</title>
  <style>
    :root { --color-primary:#5A3920; --ring:#2563EB; --radius-lg:16px; --shadow-sm:0 1px 2px rgba(0,0,0,.06); --shadow-md:0 4px 14px rgba(0,0,0,.12); }
    body { font-family: system-ui, -apple-system, Segoe UI, Tahoma, Arial; background:#FAF7F4; color:#111827; margin:0; }
    .navbar { background:#fff; border-bottom:1px solid #E5E7EB; }
    .brand { font-weight:800; text-transform:lowercase; }
    .brand-sub { font-weight:700; margin-right:.5rem; color:#9CA3AF; }
    .card { background:#fff; border:1px solid #E5DED4; border-radius:16px; padding:1rem; box-shadow: var(--shadow-sm); }
    .container { max-width: 800px; margin: 0 auto; padding: 1rem 1rem 2rem; }
    .back-link { display:inline-flex; align-items:center; gap:.4rem; padding:.4rem .75rem; background:#EFE6DD; border:1px solid #E5DED4; color:#1F2937; border-radius:9999px; text-decoration:none; font-weight:700; box-shadow: var(--shadow-sm); transition: transform .2s ease, box-shadow .2s ease, background .2s ease; }
    .back-link:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); background:#E8DFD6; }
    .back-link svg { width:18px; height:18px; }
    .input { border:1px solid #D1D5DB; border-radius:12px; padding:.6rem .85rem; font-size:1rem; background:#fff; }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.5rem .9rem; border-radius:12px; font-weight:700; box-shadow: var(--shadow-sm); }
    .btn-primary { background: var(--color-primary); color:#fff; border:0; }
    .btn-outline { background:#fff; border:1px solid #D1D5DB; }
    .section { display:grid; gap:.75rem; }
    .section-title { font-weight:800; color:#1F2937; }
    .help { font-size:.8rem; color:#6B7280; }
    @media (min-width: 640px) { .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:.75rem; } }
    .actions { display:flex; gap:.5rem; align-items:center; }
    .themes-grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:.75rem; }
    @media (min-width: 640px) { .themes-grid { grid-template-columns: repeat(5, minmax(0,1fr)); } }
    .theme-card { background:#fff; border:1px solid #E5DED4; border-radius:12px; padding:.75rem; box-shadow: var(--shadow-sm); display:grid; gap:.5rem; align-content:start; }
    .swatch { width:100%; height:56px; border-radius:8px; border:1px solid #E5DED4; }
    .theme-name { font-weight:700; font-size:.95rem; color:#1F2937; }
    .code-row { display:flex; gap:.5rem; align-items:center; }
    .code { flex:1; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.85rem; background:#F9FAFB; border:1px solid #E5E7EB; border-radius:8px; padding:.25rem .5rem; }
    .btn-sm { padding:.35rem .6rem; border-radius:10px; font-size:.85rem; }
    .wheel-wrap { display:grid; grid-template-columns: 1fr; gap:.75rem; }
    @media (min-width: 640px) { .wheel-wrap { grid-template-columns: 220px 1fr; } }
    .preview-box { width:100%; height:48px; border:1px solid #E5E7EB; border-radius:10px; }
  </style>
</head>
<body>
  <nav class="navbar w-full py-2 px-4 sm:px-8 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <span class="brand text-lg sm:text-xl">iqr menu</span>
      <span class="brand-sub">BACKOFFICE</span>
    </div>
    <a href="menu_dashboard.html" class="back-link" aria-label="الرجوع إلى اللوحة">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M15 18l-6-6 6-6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span>الرجوع إلى اللوحة</span>
    </a>
  </nav>

  <main class="container">
    <h1 class="text-2xl font-extrabold mb-3">الإعدادات</h1>
    <div class="card section">

      <h2 class="section-title">الهوية</h2>
      <div class="grid-2">
        <div>
          <label class="block text-sm text-gray-700 mb-1">اسم المنيو</label>
          <input id="menuNameInput" type="text" class="input" placeholder="مثال: مطعم XYZ" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">لوغو</label>
          <div class="actions">
            <button id="btnUploadLogo" class="btn btn-outline">إضافة لوغو</button>
            <button id="btnRemoveLogo" class="btn btn-outline">إزالة اللوغو</button>
            <span id="uploadLogoStatus" class="text-xs text-gray-500"></span>
          </div>
          <div id="logoPreviewWrap" style="display:none; margin-top:.5rem">
            <img id="logoPreview" alt="لوغو" style="width:72px; height:72px; border-radius:9999px; border:1px solid #E5DED4; object-fit:cover" />
          </div>
        </div>
      </div>

      <hr style="border:none; border-top:1px solid #E5DED4" />

      <h2 class="section-title">الاتصال</h2>
      <div class="grid-2">
        <div>
          <label class="block text-sm text-gray-700 mb-1">رقم الواتساب</label>
          <input id="whatsappNumberInput" type="text" class="input" inputmode="numeric" placeholder="96477xxxxxxxx" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">رقم الاتصال</label>
          <input id="phoneNumberInput" type="text" class="input" inputmode="numeric" placeholder="96407xxxxxxxx" />
        </div>
      </div>

      <div class="actions">
        <button id="btnSaveSettings" class="btn btn-primary">حفظ</button>
        <span id="saveSettingsStatus" class="text-xs text-gray-500"></span>
      </div>
    </div>
  </main>

  <script>
    (function initSettings() {
      const UPLOAD_ENDPOINT = '/api/upload-image';
      const picker = document.getElementById('primaryColorPicker');
      if (picker) {
        picker.addEventListener('input', () => {
          const val = picker.value || '#5A3920';
          document.documentElement.style.setProperty('--color-primary', val);
        });
      }

      const themes = [
        { name:'أزرق ملكي', hex:'#2563EB' },
        { name:'برتقالي ملتهب', hex:'#EA580C' },
        { name:'زمردي', hex:'#16A34A' },
        { name:'بنفسجي ملكي', hex:'#9333EA' },
        { name:'أحمر كارميني', hex:'#DC2626' },
        { name:'عنبر', hex:'#F59E0B' },
        { name:'أزرق سماوي', hex:'#0EA5E9' },
        { name:'بني إسبرسو', hex:'#5A3920' },
        { name:'رمادي صخري', hex:'#374151' },
        { name:'فيروزي عميق', hex:'#0B7285' },
      ];

      const toRgb = (hex) => {
        const h = hex.replace('#','');
        const r = parseInt(h.substring(0,2),16);
        const g = parseInt(h.substring(2,4),16);
        const b = parseInt(h.substring(4,6),16);
        return { r, g, b };
      };
      const rgbStr = ({r,g,b}, a=1) => `rgb(${r}, ${g}, ${b}${a<1?`, ${a.toFixed(2)}`:''})`;
      const hexFromHsl = (h,s,l) => {
        h/=360; s/=100; l/=100;
        const hue2rgb=(p,q,t)=>{ if(t<0)t+=1; if(t>1)t-=1; if(t<1/6)return p+(q-p)*6*t; if(t<1/2)return q; if(t<2/3)return p+(q-p)*(2/3-t)*6; return p; };
        const q = l<0.5 ? l*(1+s) : l+s-l*s; const p = 2*l-q;
        const r = Math.round(hue2rgb(p,q,h+1/3)*255);
        const g = Math.round(hue2rgb(p,q,h)*255);
        const b = Math.round(hue2rgb(p,q,h-1/3)*255);
        const toHex = (x)=>x.toString(16).padStart(2,'0');
        return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
      };

      const themesGrid = document.getElementById('themesGrid');
      if (themesGrid) {
        themesGrid.innerHTML = themes.map(t=>{
          const rgb = toRgb(t.hex);
          return `
            <div class="theme-card" data-hex="${t.hex}" data-name="${t.name}">
              <div class="swatch" style="background:${t.hex}"></div>
              <div class="theme-name">${t.name}</div>
              <div class="code-row"><input class="code" value="${t.hex}" readonly /><button class="btn btn-outline btn-sm" data-action="copyHex">نسخ HEX</button></div>
              <div class="code-row"><input class="code" value="${rgbStr(rgb)}" readonly /><button class="btn btn-outline btn-sm" data-action="copyRgb">نسخ RGB</button></div>
              <div class="actions">
                <button class="btn btn-primary btn-sm" data-action="apply">تطبيق</button>
              </div>
            </div>`;
        }).join('');
        themesGrid.addEventListener('click',(e)=>{
          const btn = e.target.closest('button'); if (!btn) return;
          const card = e.target.closest('.theme-card'); if (!card) return;
          const hex = card.getAttribute('data-hex')||'#5A3920';
          const action = btn.getAttribute('data-action');
          if (action==='apply') { document.documentElement.style.setProperty('--color-primary', hex); }
          else if (action==='copyHex') { navigator.clipboard && navigator.clipboard.writeText(hex); }
          else if (action==='copyRgb') { const rgb = toRgb(hex); navigator.clipboard && navigator.clipboard.writeText(rgbStr(rgb)); }
        });
      }

      const wheel = document.getElementById('colorWheel');
      const hueSlider = document.getElementById('hueSlider');
      const alphaSlider = document.getElementById('alphaSlider');
      const hexCode = document.getElementById('hexCode');
      const rgbCode = document.getElementById('rgbCode');
      const preview = document.getElementById('wheelPreview');
      const applyBtn = document.getElementById('applyWheelColor');
      let current = { h:30, s:80, l:50, a:1 };

      const renderWheel = () => {
        const ctx = wheel.getContext('2d');
        const r = wheel.width/2; const cx=r, cy=r;
        ctx.clearRect(0,0,wheel.width,wheel.height);
        for (let rr=r; rr>0; rr--) {
          for (let a=0; a<360; a+=2) {
            const x = cx + rr*Math.cos(a*Math.PI/180);
            const y = cy + rr*Math.sin(a*Math.PI/180);
            ctx.beginPath(); ctx.strokeStyle = hexFromHsl(a, (rr/r)*100, 50); ctx.lineWidth=1.8; ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.stroke();
          }
        }
      };
      const updateCodes = () => {
        const hex = hexFromHsl(current.h, current.s, current.l);
        const rgb = toRgb(hex);
        if (hexCode) hexCode.value = hex;
        if (rgbCode) rgbCode.value = rgbStr(rgb, current.a);
        if (preview) preview.style.background = current.a<1 ? rgbStr(rgb, current.a) : hex;
      };
      const setFromPoint = (x,y) => {
        const r = wheel.width/2; const cx=r, cy=r;
        const dx = x-cx, dy=y-cy; const dist = Math.sqrt(dx*dx+dy*dy);
        const sat = Math.min(100, Math.max(0, (dist/r)*100));
        let ang = Math.atan2(dy,dx)*180/Math.PI; if (ang<0) ang+=360;
        current.h = Math.round(ang); current.s = Math.round(sat); current.l = 50;
        if (hueSlider) hueSlider.value = current.h;
        updateCodes();
      };
      if (wheel) {
        renderWheel();
        wheel.addEventListener('click',(e)=>{ const rect=wheel.getBoundingClientRect(); setFromPoint(e.clientX-rect.left, e.clientY-rect.top); });
      }
      if (hueSlider) hueSlider.addEventListener('input',()=>{ current.h = Number(hueSlider.value)||0; updateCodes(); });
      if (alphaSlider) alphaSlider.addEventListener('input',()=>{ current.a = (Number(alphaSlider.value)||0)/100; updateCodes(); });
      if (applyBtn) applyBtn.addEventListener('click',()=>{ const hex = hexCode ? hexCode.value : '#5A3920'; document.documentElement.style.setProperty('--color-primary', hex); });
      updateCodes();

      const menuNameInput = document.getElementById('menuNameInput');
      const waInput = document.getElementById('whatsappNumberInput');
      const phoneInput = document.getElementById('phoneNumberInput');
      const btnSave = document.getElementById('btnSaveSettings');
      const statusEl = document.getElementById('saveSettingsStatus');
      const btnUploadLogo = document.getElementById('btnUploadLogo');
      const btnRemoveLogo = document.getElementById('btnRemoveLogo');
      const uploadLogoStatus = document.getElementById('uploadLogoStatus');
      const logoPreviewWrap = document.getElementById('logoPreviewWrap');
      const logoPreview = document.getElementById('logoPreview');
      const logoFileInput = (()=>{ const input=document.createElement('input'); input.type='file'; input.accept='image/*'; input.style.display='none'; input.tabIndex=-1; document.body.appendChild(input); return input; })();

      try {
        const name = localStorage.getItem('restaurant_menu_name') || '';
        if (menuNameInput) menuNameInput.value = name;
      } catch {}
      try {
        const wa = localStorage.getItem('restaurant_whatsapp_number') || '';
        if (waInput) waInput.value = wa;
      } catch {}
      try {
        const phone = localStorage.getItem('restaurant_phone_number') || '';
        if (phoneInput) phoneInput.value = phone;
      } catch {}
      try {
        const logo = localStorage.getItem('restaurant_logo_url') || '';
        if (logo && logoPreview) { logoPreview.src = logo; if (logoPreviewWrap) logoPreviewWrap.style.display='block'; }
      } catch {}

      function digitsOnly(raw) { return String(raw||'').replace(/\D/g,''); }

      if (btnSave) {
        btnSave.addEventListener('click', () => {
          const original = statusEl ? statusEl.textContent : '';
          if (statusEl) statusEl.textContent = 'جارِ الحفظ...';
          try {
            const name = (menuNameInput && menuNameInput.value) || '';
            const wa = digitsOnly(waInput && waInput.value);
            const phone = digitsOnly(phoneInput && phoneInput.value);
            localStorage.setItem('restaurant_menu_name', name);
            if (wa) localStorage.setItem('restaurant_whatsapp_number', wa); else localStorage.removeItem('restaurant_whatsapp_number');
            if (phone) localStorage.setItem('restaurant_phone_number', phone); else localStorage.removeItem('restaurant_phone_number');
            if (statusEl) statusEl.textContent = 'تم الحفظ ✓';
          } catch {
            if (statusEl) statusEl.textContent = 'فشل الحفظ';
          } finally {
            setTimeout(() => { if (statusEl) statusEl.textContent = original || ''; }, 1500);
          }
        });
      }

      function fileToDataURL(file) { return new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file); }); }

      if (btnUploadLogo) {
        btnUploadLogo.addEventListener('click', ()=>{ logoFileInput.value=''; logoFileInput.click(); });
      }
      if (btnRemoveLogo) {
        btnRemoveLogo.addEventListener('click', ()=>{
          const original = uploadLogoStatus ? uploadLogoStatus.textContent : '';
          try {
            localStorage.removeItem('restaurant_logo_url');
            if (logoPreview) logoPreview.src = '';
            if (logoPreviewWrap) logoPreviewWrap.style.display='none';
            if (uploadLogoStatus) uploadLogoStatus.textContent = 'تمت الإزالة ✓';
          } catch {
            if (uploadLogoStatus) uploadLogoStatus.textContent = 'فشلت الإزالة';
          } finally {
            setTimeout(()=>{ if (uploadLogoStatus) uploadLogoStatus.textContent = original || ''; }, 1200);
          }
        });
      }

      logoFileInput.addEventListener('change', async ()=>{
        const file = logoFileInput.files[0];
        if (!file) return;
        const original = uploadLogoStatus ? uploadLogoStatus.textContent : '';
        if (uploadLogoStatus) uploadLogoStatus.textContent = 'جارِ الرفع...';
        try {
          const dataUrl = await fileToDataURL(file);
          const resp = await fetch(UPLOAD_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename:file.name, data:dataUrl }) });
          const json = await resp.json().catch(()=>({}));
          if (!resp.ok || !json.ok || !json.path) throw new Error(json.error||'فشل الرفع');
          localStorage.setItem('restaurant_logo_url', json.path);
          if (logoPreview) logoPreview.src = json.path;
          if (logoPreviewWrap) logoPreviewWrap.style.display='block';
          if (uploadLogoStatus) uploadLogoStatus.textContent = 'تم الرفع ✓';
        } catch {
          if (uploadLogoStatus) uploadLogoStatus.textContent = 'فشل الرفع';
        } finally {
          setTimeout(()=>{ if (uploadLogoStatus) uploadLogoStatus.textContent = original || ''; }, 1500);
        }
      });
    })();
  </script>
</body>
</html>
