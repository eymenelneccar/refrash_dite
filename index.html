<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ريفريش دايت</title>
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- خط Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        // إعداد ألوان Tailwind المخصصة
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'beige': '#F5F5DC', // لون الخلفية
                        'coffee': '#331A12', // لون الأزرار والسلة
                        'peach': '#FFCC80', // لون الآيتيمات
                        'accent': '#E53935', // لون التكحيل (التمييز)
                    },
                    fontFamily: {
                        'sans': ['Cairo', 'Inter', 'sans-serif'], // استخدام خط Cairo للعربية
                    }
                }
            }
        }
    </script>
    <style>
        /* لإخفاء شريط التمرير */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        /* سحب سلس على iOS للأشرطة القابلة للتمرير */
        .overflow-touch {
            -webkit-overflow-scrolling: touch;
        }
        /* لضمان عمل الخط العربي بشكل صحيح */
        body {
            font-family: 'Cairo', 'Inter', 'sans-serif;
        }
            /* مؤثرات الحركة */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(14px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in .4s ease-out both; }
        .animate-slide-up { animation: slide-up .45s ease-out both; }
        /* دعم لمس سريع للأزرار والعناصر التفاعلية */
        .touch-manipulation { touch-action: manipulation; }
        /* قص نص لسطريْن مع إخفاء الفائض */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* تقليل الحركة للمستخدمين الذين يفضلون ذلك */
        @media (prefers-reduced-motion: reduce) {
            .animate-fade-in, .animate-slide-up { animation: none !important; }
        }
</style>
</head>
<body class="bg-[#f3efe8] font-sans">

    <!-- الحاوية: عرض كامل على الجوال، أوسع على الحواسيب -->
    <div class="mx-auto min-h-screen bg-[#f3efe8] relative pb-24 max-w-full lg:max-w-5xl xl:max-w-6xl shadow-lg lg:shadow-none">

        <!-- الهيدر: العنوان + زر السلة -->
        <!-- header padding: from px-3 to px-2 -->
        <header class="flex justify-between items-center px-2 py-4 sticky top-0 bg-white/80 backdrop-blur-sm z-10 border-b border-coffee/10">
            <div class="flex flex-col items-start leading-tight">
                <!-- مركّب العنوان عند ظهور عنوان فرعي: اسم القسم (غامق) | العنوان الفرعي (صغير) -->
                <div id="sticky-composite" class="hidden flex items-baseline">
                    <span id="sticky-section" class="text-2xl font-bold text-coffee"></span>
                    <span class="mx-1 text-coffee/30">|</span>
                    <span id="sticky-subheading" class="text-sm font-normal text-coffee/70"></span>
                </div>
                <!-- العنوان الافتراضي -->
                <h1 id="site-title" data-default="ريفريش دايت" class="text-2xl font-bold text-coffee">ريفريش دايت</h1>
                <span id="site-brand-madeby" class="text-xs font-normal text-coffee/60 mt-0.5">Made by dietcity</span>
                <!-- اسم القسم الصغير أسفل العنوان عندما لا يظهر المركّب -->
                <span id="site-section-name" class="text-xs font-normal text-coffee/60 mt-0.5 hidden"></span>
            </div>
            <div class="flex items-center gap-2">
                <button id="open-cart-btn" class="relative">
                    <img src="shopping-bag.png" alt="أيقونة السلة" class="w-8 h-8 object-contain" loading="eager" />
                    <span id="cart-count-bubble" class="absolute -top-2 -right-2 bg-accent text-white text-xs font-bold rounded-full px-2 py-0.5 hidden">0</span>
                </button>
                <a href="review.html" class="px-3 py-2 rounded-lg border border-[#5c4c3c] text-[#5c4c3c] font-bold hover:bg-[#5c4c3c]/10 transition-colors">قيمنا</a>
            </div>
        </header>

        <!-- قسم الهيرو (جديد) -->
        <!-- hero section padding: from px-3 to px-2 -->
        <section id="hero-section" class="px-2 py-4">
<div class="relative rounded-xl overflow-hidden shadow-lg h-64 sm:h-72 lg:h-80 bg-coffee animate-fade-in">
                <!-- يمكنك تغيير الصورة من هنا -->
                <img id="hero-image" src="https://placehold.co/600x400/331A12/FFCC80?text=أطباقنا+المميزة" alt="صورة ترحيبية" class="w-full h-full object-cover opacity-80">
                <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent flex items-end p-6">
                    <h2 id="hero-title" class="text-3xl font-bold text-white leading-tight">
                        <span id="hero-title-text">أهلاً بك في</span><br><span id="hero-subtitle">ريفريش دايت</span>
                    </h2>
                </div>
            </div>
        </section>

        <!-- شريط الأقسام (قابل للتمرير) -->
        <nav class="px-3 py-4"> <!-- تم تعديل الحشو -->
            <h3 class="text-coffee font-bold mb-2">الأقسام</h3>
            <!-- categories nav inner padding: from px-3 to px-2 -->
            <div id="categories-nav" class="flex items-center gap-4 overflow-x-auto overflow-touch scrollbar-hide snap-x snap-mandatory px-2 py-1" style="scroll-padding: 1rem;"> <!-- سكرول أفقي للفئات مع padding للأطراف -->
                <!-- سيتم ملء الأزرار هنا بواسطة الجافاسكربت -->
            </div>
        </nav>

        <!-- عنوان القسم الحالي -->
        <div id="current-category-title" class="px-2 text-coffee font-bold text-lg mb-2"></div>

        <!-- قسم عرض المنتجات -->
        <main id="items-container" role="list" aria-label="قائمة الأصناف" class="px-2 py-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 sm:gap-6 lg:gap-8"> <!-- شبكة متجاوبة: 1/2/3/4 أعمدة ، زيادة الهوامش بين البطاقات -->
            <!-- سيتم ملء المنتجات هنا -->
        </main>

        <!-- شريط التنقل السفلي -->
        <footer class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)] z-10 border-t border-coffee/10">
            <div id="bottom-nav" class="flex justify-around items-center p-2">
                <!-- سيتم ملء الأيقونات هنا -->
            </div>
            <div class="border-t border-coffee/10 text-center text-[11px] text-coffee/60 px-2 py-1">
              تم صنعها بواسطة |
              <a href="https://iqrarabic.com/" target="_blank" rel="noopener" class="font-semibold text-[#5c4c3c] hover:text-[#5c4c3c] hover:underline">İQR MENU</a>
            </div>
            <!-- قائمة المزيد المنبثقة -->
            <div id="more-menu" class="hidden fixed bottom-16 left-0 right-0 max-w-lg mx-auto px-3 z-20">
                <div class="bg-white border border-coffee/20 rounded-xl shadow-lg p-3 flex items-center justify-around gap-6">
                    <a id="instagram-btn" href="#" target="_blank" rel="noopener" class="flex flex-col items-center text-xs text-coffee/80 hover:text-accent">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5Zm5 5a5 5 0 1 0 0 10 5 5 0 0 0 0-10Zm6.5-.75a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5Z"/></svg>
                        <span>Instagram</span>
                    </a>
                    <a id="facebook-btn" href="#" target="_blank" rel="noopener" class="flex flex-col items-center text-xs text-coffee/80 hover:text-accent">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mb-1"><path d="M13.5 9H16V6h-2.5a3.5 3.5 0 0 0-3.5 3.5V12H8v3h2v6h3v-6h2.2l.8-3H13.5V9Z"/></svg>
                        <span>Facebook</span>
                    </a>
                </div>
            </div>
        </footer>

        <!-- نافذة السلة (مخفية افتراضيًا) -->
        <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" aria-hidden="true">
            <!-- حاوية السلة الجانبية -->
            <div id="cart-drawer" class="fixed top-0 right-0 w-full max-w-md h-full bg-[#f3efe8] z-50 shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out">
                
                <!-- هيدر السلة -->
                <div id="cart-header" class="flex justify-between items-center p-4 border-b border-coffee/20">
                    <h2 class="text-xl font-bold text-coffee">سلة طلباتك</h2>
                    <button id="close-cart-btn">
                        <!-- أيقونة إغلاق -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-coffee">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- محتويات السلة -->
                <div id="cart-items" class="p-4 space-y-4 overflow-y-auto bg-white">
                    <!-- سيتم ملء عناصر السلة هنا -->
                    <!-- <p class="text-center text-coffee/70">سلتك فارغة.</p> -->
                </div>

                <!-- فوتر السلة (الإجمالي والطلب) -->
                <div id="cart-footer" class="absolute bottom-0 left-0 right-0 p-4 bg-[#f3efe8] border-t border-coffee/20">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-lg font-semibold text-coffee">الإجمالي:</span>
                        <span id="cart-total" class="text-2xl font-bold text-[#5c4c3c]">0 د.ع</span>
                    </div>
                    <button id="submit-order-btn" class="w-full bg-[#5c4c3c] text-white py-3 rounded-lg font-bold text-lg hover:bg-[#5c4c3c] transition-colors inline-flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M2.25 12c0-4.28 3.47-7.75 7.75-7.75s7.75 3.47 7.75 7.75-3.47 7.75-7.75 7.75S2.25 16.28 2.25 12Zm9.25-3.25a.75.75 0 0 0-1.5 0v3.25c0 .414.336.75.75.75h3.25a.75.75 0 0 0 0-1.5h-2.5V8.75Z"/></svg>
                        إرسال الطلب
                    </button>
                    <div class="text-center text-coffee/60 text-sm my-2">or</div>
                    <a id="call-order-btn" href="#" class="block w-full text-center border border-[#5c4c3c] text-[#5c4c3c] py-2 rounded-lg font-bold hover:bg-[#5c4c3c]/10 transition-colors inline-flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M2.25 6.75A3 3 0 0 1 5.25 3.75h1.5a2.25 2.25 0 0 1 2.25 2.25v2.25a2.25 2.25 0 0 1-2.25 2.25h-.375a11.25 11.25 0 0 0 6.75 6.75V16.5a2.25 2.25 0 0 1 2.25-2.25h2.25a2.25 2.25 0 0 1 2.25 2.25v1.5a3 3 0 0 1-3 3h-.75c-8.284 0-15-6.716-15-15v-.75Z"/></svg>
                        اطلب عبر اتصال
                    </a>
                </div>

            </div>
        </div>

        <!-- نافذة معاينة المنتج -->
        <div id="item-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" aria-hidden="true">
            <div class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] max-w-md bg-white rounded-xl shadow-xl overflow-hidden">
                <div class="relative w-full pt-[100%]">
                    <img id="item-preview-image" src="" alt="" class="absolute inset-0 w-full h-full object-cover">
                    <button id="close-item-btn" class="absolute top-2 left-2 bg-black/50 text-white rounded-full w-8 h-8 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="p-4 space-y-2">
                    <h3 id="item-preview-name" class="text-xl font-bold text-coffee"></h3>
                    <p id="item-preview-description" class="text-sm text-coffee/80"></p>
                    <div id="item-addons" class="space-y-2 hidden border-t border-coffee/10 pt-2 mt-2 max-h-40 overflow-y-auto">
                        <h4 class="text-sm font-bold text-coffee">الإضافات</h4>
                        <div id="item-addons-choices" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <span id="item-preview-price" class="text-lg font-bold text-coffee"></span>
                        <button id="item-preview-add" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-colors">أضف للسلة</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- مودال التنبيه المخصص -->
        <div id="app-alert" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
            <div id="app-alert-backdrop" class="absolute inset-0 bg-black/40"></div>
            <div class="relative w-full max-w-sm sm:max-w-md bg-white rounded-2xl shadow-2xl p-5 text-center animate-fade-in max-h-[80vh] overflow-y-auto">
                <div id="app-alert-icon" class="mx-auto mb-3 text-accent">
                    <!-- افتراضي: تحذير -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10"><path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 6v6a1 1 0 1 1-2 0V8a1 1 0 1 1 2 0Zm-1 10a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3Z"/></svg>
                </div>
                <div id="app-alert-message" class="text-coffee text-base leading-7"></div>
                <button id="app-alert-ok" class="mt-4 w-full bg-accent text-white py-2.5 rounded-lg font-bold hover:bg-red-700 transition-colors">حسناً</button>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- بيانات المنيو الوهمية ---
            let menuData = {
                "مقبلات": [
                    { id: 1, name: "بروشيتا الطماطم", description: "خبز محمص مع طماطم طازجة، ريحان، وثوم.", price: 25, image: "https://placehold.co/100x100/331A12/FFCC80?text=مقبلات" },
                    { id: 2, name: "حلقات البصل المقرمشة", description: "تقدم مع صلصة الباربيكيو الكريمية.", price: 30, image: "https://placehold.co/100x100/331A12/FFCC80?text=مقبلات" },
                    { id: 3, name: "أجنحة دجاج بافلو", description: "أجنحة دجاج حارة تقدم مع صلصة الرانش.", price: 40, image: "https://placehold.co/100x100/331A12/FFCC80?text=مقبلات" },
                ],
                "رئيسية": [
                    { id: 4, name: "ستيك ريب آي", description: "قطعة ستيك 300 جرام مشوية حسب الطلب.", price: 120, image: "https://placehold.co/100x100/331A12/FFCC80?text=رئيسي" },
                    { id: 5, name: "سلمون مشوي", description: "فيليه سلمون طازج مع الهليون والليمون.", price: 95, image: "https://placehold.co/100x100/331A12/FFCC80?text=رئيسي" },
                    { id: 6, name: "باستا ألفريدو بالدجاج", description: "باستا فيتوتشيني بصلصة ألفريدو الكريمية.", price: 70, image: "https://placehold.co/100x100/331A12/FFCC80?text=رئيسي" },
                    { id: 11, name: "بيتزا مارجريتا", description: "عجينة طازجة مع صلصة الطماطم والريحان.", price: 50, image: "https://placehold.co/100x100/331A12/FFCC80?text=بيتزا", addOns: [
                        { name: "جبنة إضافية", price: 5, default: false },
                        { name: "لحم مفروم", price: 7, default: false },
                        { name: "فطر", price: 3, default: false }
                    ] },
                ],
                "حلويات": [
                    { id: 7, name: "تشيز كيك فراولة", description: "طبقة غنية من التشيز كيك مع صوص الفراولة.", price: 35, image: "https://placehold.co/100x100/331A12/FFCC80?text=حلى" },
                    { id: 8, name: "براوني الشوكولاتة", description: "براوني دافئ يقدم مع آيس كريم فانيلا.", price: 40, image: "https://placehold.co/100x100/331A12/FFCC80?text=حلى" },
                ],
                "مشروبات": [
                    { id: 9, name: "عصير برتقال طازج", description: "عصير برتقال طبيعي 100%.", price: 20, image: "https://placehold.co/100x100/331A12/FFCC80?text=مشروب" },
                    { id: 10, name: "موهيتو ليمون ونعناع", description: "مشروب منعش بالليمون والنعناع.", price: 25, image: "https://placehold.co/100x100/331A12/FFCC80?text=مشروب" },
                ]
            };
            
            // أيقونات شريط التنقل السفلي
            const navIcons = {
                "مقبلات": `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mb-1"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L1.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.25 12l2.846.813a4.5 4.5 0 0 1 3.09 3.09L25.75 18l-.813 2.846a4.5 4.5 0 0 1-3.09 3.09L18.25 24l-2.846-.813a4.5 4.5 0 0 1-3.09-3.09L11.75 18l.813-2.846a4.5 4.5 0 0 1 3.09-3.09L18.25 12Z" /></svg>`,
                "رئيسية": `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mb-1"><path stroke-linecap="round" stroke-linejoin="round" d="m21 7.5-9-5.25L3 7.5m18 0-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" /></svg>`,
                "حلويات": `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mb-1"><path stroke-linecap="round" stroke-linejoin="round" d="M21 11.25v8.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5v-8.25M12 4.875A3.375 3.375 0 0 0 12 1.5v3.375Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 11.25h16.5a1.5 1.5 0 0 1 1.5 1.5v3.75a1.5 1.5 0 0 1-1.5 1.5H3.75a1.5 1.5 0 0 1-1.5-1.5v-3.75a1.5 1.5 0 0 1 1.5-1.5Z" /></svg>`,
                "مشروبات": `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mb-1"><path stroke-linecap="round" stroke-linejoin="round" d="M.75 3.75h16.5a1.5 1.5 0 0 1 1.5 1.5v11.25a1.5 1.5 0 0 1-1.5 1.5H.75a1.5 1.5 0 0 1-1.5-1.5V5.25a1.5 1.5 0 0 1 1.5-1.5Zm13.5 0V.75" /></svg>`
            };

            // صور للفئات
            let categoryImages = {
                "مقبلات": "https://placehold.co/300x300/FFCC80/331A12?text=مقبلات",
                "رئيسية": "https://placehold.co/300x300/0EA5E9/ffffff?text=رئيسية",
                "حلويات": "https://placehold.co/300x300/EF4444/ffffff?text=حلويات",
                "مشروبات": "https://placehold.co/300x300/10B981/ffffff?text=مشروبات"
            };

            // --- عناصر الواجهة ---
            const itemsContainer = document.getElementById('items-container');
            const categoriesNav = document.getElementById('categories-nav');
            const bottomNav = document.getElementById('bottom-nav');
            const cartModal = document.getElementById('cart-modal');
            const cartDrawer = document.getElementById('cart-drawer');
            const openCartBtn = document.getElementById('open-cart-btn');
            const closeCartBtn = document.getElementById('close-cart-btn');
            const cartItemsContainer = document.getElementById('cart-items');
            const cartTotalEl = document.getElementById('cart-total');
            const cartCountBubble = document.getElementById('cart-count-bubble');
            const submitOrderBtn = document.getElementById('submit-order-btn');
            const callOrderBtn = document.getElementById('call-order-btn');
            const currentCategoryTitle = document.getElementById('current-category-title');
            const moreMenu = document.getElementById('more-menu');
            // عناصر معاينة المنتج
            const itemModal = document.getElementById('item-modal');
            const closeItemBtn = document.getElementById('close-item-btn');
            const itemPreviewImage = document.getElementById('item-preview-image');
            const itemPreviewName = document.getElementById('item-preview-name');
            const itemPreviewDescription = document.getElementById('item-preview-description');
            const itemPreviewPrice = document.getElementById('item-preview-price');
            const itemPreviewAdd = document.getElementById('item-preview-add');
            const itemAddonsSection = document.getElementById('item-addons');
            const itemAddonsChoices = document.getElementById('item-addons-choices');

            // مودال التنبيه المخصص (متاح عبر التطبيق كاملًا)
            const appAlert = document.getElementById('app-alert');
            const appAlertMsg = document.getElementById('app-alert-message');
            const appAlertIcon = document.getElementById('app-alert-icon');
            const appAlertOk = document.getElementById('app-alert-ok');
            const appAlertBackdrop = document.getElementById('app-alert-backdrop');

            function showAppAlert(message, type = 'warning') {
                if (!appAlert) return alert(message);
                appAlertMsg.textContent = message || '';
                // ضبط الأيقونة حسب النوع
                let svg = '';
                if (type === 'success') {
                    svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10"><path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm4.7 7.3a1 1 0 0 1 0 1.4l-5 5a1 1 0 0 1-1.4 0l-2-2a1 1 0 1 1 1.4-1.4l1.3 1.3 4.3-4.3a1 1 0 0 1 1.4 0Z"/></svg>';
                    appAlertIcon.className = 'mx-auto mb-3 text-coffee';
                } else if (type === 'info') {
                    svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10"><path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 6a1 1 0 1 1-2 0 1 1 0 0 1 2 0Zm-1 3a1 1 0 0 1 1 1v6a1 1 0 1 1-2 0v-6a1 1 0 0 1 1-1Z"/></svg>';
                    appAlertIcon.className = 'mx-auto mb-3 text-coffee';
                } else {
                    svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10"><path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 6v6a1 1 0 1 1-2 0V8a1 1 0 1 1 2 0Zm-1 10a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3Z"/></svg>';
                    appAlertIcon.className = 'mx-auto mb-3 text-accent';
                }
                appAlertIcon.innerHTML = svg;
                appAlert.classList.remove('hidden');
            }

            function hideAppAlert() {
                if (!appAlert) return;
                appAlert.classList.add('hidden');
            }
            if (appAlertOk) appAlertOk.addEventListener('click', hideAppAlert);
            if (appAlertBackdrop) appAlertBackdrop.addEventListener('click', hideAppAlert);
            window.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideAppAlert(); });

            // --- حالة التطبيق ---
            let cart = [];
            let currentCategory = ""; // سيتم تحديده بعد التحميل من السيرفر
            let settings = {};
            let hero = {};
            let announcements = {};
            let categoriesList = [];
            // مؤقت عرض الهيرو
            let heroTimer = null;
            // ... existing code ...

            // عرض أزرار الأقسام (العلوي والسفلي)
            function renderCategories() {
                categoriesNav.innerHTML = '';
                bottomNav.innerHTML = '';
                const cats = (Array.isArray(categoriesList) && categoriesList.length)
                  ? categoriesList
                  : Object.keys(menuData);
                cats.forEach(category => {
                    // شريط الأقسام العلوي (بطاقات صور)
                    const btn = document.createElement('button');
                    btn.className = `category-btn relative overflow-hidden rounded-xl shadow-lg transition-transform shrink-0 w-28 aspect-square snap-start ring-offset-2 ring-offset-beige animate-fade-in touch-manipulation ${
                        category === currentCategory ? 'ring-2 ring-accent' : 'hover:scale-[1.02]'
                    }`;
                    btn.innerHTML = `
                        <img src="${categoryImages[category] || 'https://placehold.co/300x300'}" alt="${category}" class="absolute inset-0 w-full h-full object-cover" loading="lazy" decoding="async" sizes="(max-width: 640px) 35vw, 20vw" />
                        <span class="absolute bottom-2 left-2 right-2 bg-black/40 text-white text-xs sm:text-sm font-bold px-2 py-1 rounded-md text-center">${category}</span>
                    `;
                    btn.setAttribute('aria-label', `فتح قسم ${category}`);
                    btn.dataset.category = category;
                    categoriesNav.appendChild(btn);

                    // شريط التنقل السفلي (يبنى ثابتاً لاحقاً)
                    const navItem = document.createElement('button');
                    navItem.className = `category-btn flex flex-col items-center text-xs transition-colors ${
                        category === currentCategory ? 'text-accent' : 'text-coffee/60'
                    }`;
                    navItem.dataset.category = category;
                    navItem.innerHTML = `
                        ${navIcons[category] || ''}
                        <span>${category}</span>
                    `;
                    // لا نضيف عناصر للفوتر هنا لأننا سنبنيه ثابتاً
                });

                // بناء شريط التنقل السفلي الثابت
                bottomNav.innerHTML = `
                    <button id="btn-map" class="flex flex-col items-center text-xs text-coffee/80">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.5-7.5 11.25-7.5 11.25S4.5 18 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
                        </svg>
                        <span>الخريطة</span>
                    </button>
                    <button id="btn-menu" aria-label="فتح المنيو" class="w-16 h-16 -mt-7 rounded-full bg-[#5c4c3c] text-white shadow-xl ring-4 ring-[#5c4c3c]/30 flex items-center justify-center transition-transform hover:scale-105 active:scale-95">
                        <img src="fast-food.png" alt="منيو" class="w-10 h-10 object-contain filter brightness-0 invert" loading="eager" />
                    </button>
                    <button id="btn-more" class="flex flex-col items-center text-xs text-coffee/80">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Zm7 0a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Zm7 0a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" />
                        </svg>
                        <span>المزيد</span>
                    </button>
                `;

                // إضافة مستمعي الأحداث للأزرار الجديدة
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.addEventListener('click', () => changeCategory(btn.dataset.category));
                });
                document.getElementById('btn-map')?.addEventListener('click', () => {
                    const link = settings.mapLink || 'https://maps.google.com';
                    window.open(link, '_blank');
                });
                document.getElementById('btn-menu')?.addEventListener('click', () => {
                    document.getElementById('items-container')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
                document.getElementById('btn-more')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (moreMenu) moreMenu.classList.toggle('hidden');
                });
                // إغلاق القائمة عند الضغط خارجها
                window.addEventListener('click', (e) => {
                    if (!moreMenu || moreMenu.classList.contains('hidden')) return;
                    const target = e.target;
                    const btnMore = document.getElementById('btn-more');
                    if (btnMore && (btnMore === target || (target.closest && target.closest('#btn-more')))) return;
                    if (target.closest && target.closest('#more-menu')) return;
                    moreMenu.classList.add('hidden');
                });
            }

            // عرض المنتجات حسب القسم
            function renderMenuItems(category) {
                if (currentCategoryTitle) {
                    currentCategoryTitle.textContent = category;
                }
                // عرض اسم القسم الصغير في الهيدر عندما لا يظهر المركّب
                const siteSectionNameEl = document.getElementById('site-section-name');
                if (siteSectionNameEl) siteSectionNameEl.textContent = category || '';
                itemsContainer.innerHTML = '';
                const list = Array.isArray(menuData[category]) ? menuData[category] : [];
                if (!list.length) {
                    itemsContainer.innerHTML = `<p class="text-center text-coffee/70 mt-10">لا توجد أصناف في هذا القسم بعد.</p>`;
                    return;
                }
                list.forEach(item => {
                    // إذا كان العنصر عنوانًا فرعيًا، اعرضه كفاصل بصري وليس بطاقة منتج
                    if (item && item.type === 'subheading') {
                        const sub = document.createElement('div');
                        sub.className = 'subheading-marker col-span-full w-full px-4 py-2 my-3 bg-[#F5E9D5]/80 text-coffee font-bold rounded-lg animate-fade-in';
                        sub.setAttribute('data-subheading', item.name || '');
                        sub.textContent = item.name;
                        itemsContainer.appendChild(sub);
                        return;
                    }

                    const itemCard = document.createElement('div');
                    // تغيير: تصميم الكارت من أفقي إلى عمودي (مربع)
                    itemCard.className = 'bg-[#bb9b7c]/60 rounded-xl shadow-md hover:shadow-lg overflow-hidden flex flex-col animate-slide-up transition duration-300 hover:scale-[1.02]';
                    itemCard.innerHTML = `
                        ${item.image ? `<div class="relative w-full pt-[80%]"><img src="${item.image}" alt="${item.name}" class="absolute inset-0 w-full h-full object-cover" loading="lazy" decoding="async" sizes="(max-width: 640px) 50vw, (max-width: 1024px) 33vw, 25vw" onerror="this.style.display='none'" /></div>` : ''}
                        <div class="p-4 flex flex-col flex-1">
                            <h3 class="font-bold text-md lg:text-lg text-coffee truncate">${item.name}</h3>
                            <p class="text-sm lg:text-base text-coffee/80 mt-1 break-words flex-1 line-clamp-2">${item.description}</p>
                            ${Array.isArray(item.addOns) && item.addOns.length ? `
                            <div class="mt-2">
                                <button class="toggle-addons px-2 py-1 border border-coffee/20 rounded-full text-xs text-coffee hover:bg-white/40">الإضافات</button>
                                <div class="addons-card hidden mt-2 max-h-24 overflow-y-auto flex flex-wrap gap-2">
                                    ${item.addOns.map((a,i)=>`
                                        <label class=\"inline-flex items-center gap-2 border border-coffee/20 rounded-full px-3 py-1 text-xs bg-white/70\">
                                            <input type=\"checkbox\" data-idx=\"${i}\" data-price=\"${Number(a.price)||0}\" ${a.default? 'checked' : ''}/>
                                            <span>${a.name}</span>
                                            <span class=\"text-coffee/70\">(+${Number(a.price)||0} د.ع)</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                            <div class="flex justify-between items-center mt-4">
                                <span class="item-price font-bold text-md lg:text-lg text-coffee whitespace-nowrap" data-base-price="${Number(item.price)||0}">${item.price} د.ع</span>
                                <button class="add-to-cart-btn bg-[#5c4c3c] text-white w-11 h-11 lg:w-12 lg:h-12 flex items-center justify-center rounded-full hover:bg-[#5c4c3c] transition-colors flex-shrink-0 touch-manipulation" aria-label="أضف ${item.name} إلى السلة">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;

                    // تحسين الوصول: اعتبار البطاقة عنصر قائمة قابل للتركيز
                    itemCard.setAttribute('role', 'listitem');
                    itemCard.setAttribute('tabindex', '0');
                    itemCard.setAttribute('aria-label', `${item.name} - فتح التفاصيل`);

                    const addBtn = itemCard.querySelector('.add-to-cart-btn');
                    const priceEl = itemCard.querySelector('.item-price');
                    const toggleBtn = itemCard.querySelector('.toggle-addons');
                    const addonsBox = itemCard.querySelector('.addons-card');

                    function updateCardPrice(){
                        if (!priceEl) return;
                        const base = Number(priceEl.getAttribute('data-base-price')) || 0;
                        const sum = Array.from(addonsBox?.querySelectorAll('input[type="checkbox"]')||[])
                            .filter(cb=> cb.checked)
                            .reduce((acc,cb)=> acc + (Number(cb.getAttribute('data-price'))||0), 0);
                        priceEl.textContent = `${base + sum} د.ع`;
                    }

                    if (toggleBtn) {
                        toggleBtn.addEventListener('click', (e)=>{ e.stopPropagation(); addonsBox?.classList.toggle('hidden'); });
                    }
                    if (addonsBox) {
                        addonsBox.addEventListener('click', (e)=> e.stopPropagation());
                        addonsBox.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.addEventListener('change', updateCardPrice));
                        updateCardPrice();
                    }

                    addBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const base = Number(item.price)||0;
                        const selected = Array.from(addonsBox?.querySelectorAll('input[type="checkbox"]')||[])
                            .map((cb,idx)=> ({ cb, idx }))
                            .filter(x=> x.cb.checked)
                            .map(x=> (Array.isArray(item.addOns)? item.addOns[x.idx] : null))
                            .filter(Boolean);
                        const extra = selected.reduce((s,a)=> s + (Number(a.price)||0), 0);
                        const idSig = selected.map(a=>`${a.name}:${Number(a.price)||0}`).join('|');
                        const cartItem = selected.length ? { ...item, id: `${item.id}|${idSig}` , price: base + extra, selectedAddOns: selected } : { ...item };
                        flashAddFeedback(addBtn);
                        addToCart(cartItem);
                    });

                    itemCard.addEventListener('click', (e) => {
                        const el = e.target;
                        if (el && typeof el.closest === 'function' && el.closest('.add-to-cart-btn')) return;
                        openItemPreview(item);
                    });

                    // فتح التفاصيل عبر لوحة المفاتيح
                    itemCard.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            openItemPreview(item);
                        }
                    });

                    itemsContainer.appendChild(itemCard);
                });
                // بعد إعادة العرض، فعّل تتبع العناوين الفرعية لتحديث العنوان في الهيدر عند التمرير
                ensureStickyTitle();
            }
            // عنوان الهيدر يتغيّر حسب العنوان الفرعي الظاهر
            const headerEl = document.querySelector('header');
            const stickyComposite = document.getElementById('sticky-composite');
            const stickySection = document.getElementById('sticky-section');
            const stickySubheading = document.getElementById('sticky-subheading');
            const siteTitleEl = document.getElementById('site-title');
            const siteSectionNameElGlobal = document.getElementById('site-section-name');
            const siteBrandMadeBy = document.getElementById('site-brand-madeby');
            const scrollUpBtn = document.getElementById('scroll-up-btn');
            const defaultBrand = (siteTitleEl?.getAttribute('data-default') || siteTitleEl?.textContent || '');
            function getSubheadings() {
                try { return Array.from(itemsContainer.querySelectorAll('.subheading-marker')); } catch { return []; }
            }
            function updateStickyTitle() {
                const headerH = headerEl ? headerEl.offsetHeight : 0;
                const subs = getSubheadings();
                let current = null;
                for (const el of subs) {
                    const rect = el.getBoundingClientRect();
                    if (rect.top <= headerH + 4) current = el; // آخر عنوان فرعي اجتاز الهيدر
                }
                if (current) {
                    const t = (current.getAttribute('data-subheading') || current.textContent || '').trim();
                    if (stickyComposite) stickyComposite.classList.remove('hidden');
                    if (siteTitleEl) siteTitleEl.classList.add('hidden');
                    if (siteSectionNameElGlobal) siteSectionNameElGlobal.classList.add('hidden');
                    if (siteBrandMadeBy) siteBrandMadeBy.classList.add('hidden');
                    if (stickySection) stickySection.textContent = (typeof currentCategory !== 'undefined' && currentCategory) ? currentCategory : (siteSectionNameElGlobal?.textContent || '');
                    if (stickySubheading) stickySubheading.textContent = t || '';
                } else {
                    const itemsTop = itemsContainer ? itemsContainer.getBoundingClientRect().top : Infinity;
                    const beyondIntro = itemsTop <= headerH + 4; // دخلنا منطقة العناصر/القسم
                    if (subs.length === 0 && beyondIntro) {
                        // لا توجد عناوين فرعية: اعرض اسم القسم بدل البراند أثناء التمرير داخل القسم
                        if (stickyComposite) stickyComposite.classList.add('hidden');
                        if (siteTitleEl) { siteTitleEl.classList.remove('hidden'); siteTitleEl.textContent = (typeof currentCategory !== 'undefined' && currentCategory) ? currentCategory : defaultBrand; }
                        if (siteSectionNameElGlobal) siteSectionNameElGlobal.classList.add('hidden');
                        if (siteBrandMadeBy) siteBrandMadeBy.classList.remove('hidden');
                    } else {
                        // أعلى الصفحة أو قسم فيه عناوين فرعية ولم يظهر عنوان منها بعد: اعرض البراند الافتراضي
                        if (stickyComposite) stickyComposite.classList.add('hidden');
                        if (siteTitleEl) { siteTitleEl.classList.remove('hidden'); siteTitleEl.textContent = defaultBrand; }
                        if (siteSectionNameElGlobal) siteSectionNameElGlobal.classList.add('hidden');
                        if (siteBrandMadeBy) siteBrandMadeBy.classList.remove('hidden');
                    }
                }
                // إظهار/إخفاء زر السهم للأعلى حسب التمرير
                if (scrollUpBtn) {
                    const docH = Math.max(document.documentElement.scrollHeight, document.body?.scrollHeight || 0);
                    const viewH = window.innerHeight || 0;
                    const scrollable = Math.max(docH - viewH, 0);
                    const threshold = Math.max(scrollable * 0.5, headerH + 20);
                    if (window.scrollY > threshold) scrollUpBtn.classList.remove('hidden');
                    else scrollUpBtn.classList.add('hidden');
                }
            }
            let stickyTitleInitialized = false, scrollingTick = false;
            function onScrollStickyTitle() {
                if (scrollingTick) return;
                scrollingTick = true;
                requestAnimationFrame(() => { scrollingTick = false; updateStickyTitle(); });
            }
            function ensureStickyTitle() {
                if (!stickyTitleInitialized) {
                    window.addEventListener('scroll', onScrollStickyTitle, { passive: true });
                    window.addEventListener('resize', onScrollStickyTitle);
                    // نقر زر السهم: انتقل إلى بداية الأقسام أعلى شبكة العناصر
                    if (scrollUpBtn) {
                        scrollUpBtn.addEventListener('click', () => {
                            const h = headerEl ? headerEl.offsetHeight : 0;
                            const targetTop = itemsContainer ? (window.scrollY + itemsContainer.getBoundingClientRect().top - h - 8) : 0;
                            window.scrollTo({ top: Math.max(targetTop, 0), behavior: 'smooth' });
                        });
                    }
                    stickyTitleInitialized = true;
                }
                onScrollStickyTitle();
            }
            // تطبيق إعدادات الهيرو على الصفحة
            function applyHeroToPage() {
                const section = document.getElementById('hero-section');
                const img = document.getElementById('hero-image');
                const titleTextEl = document.getElementById('hero-title-text');
                const subtitleEl = document.getElementById('hero-subtitle');
                if (!section) return;
                const enabled = hero && (hero.enabled !== false);
                section.classList.toggle('hidden', !enabled);
                if (!enabled) { if (heroTimer) { clearInterval(heroTimer); heroTimer = null; } return; }

                const images = Array.isArray(hero?.images) ? hero.images.filter(Boolean) : [];
                const single = (hero && typeof hero.imageUrl === 'string') ? hero.imageUrl : '';
                const first = images[0] || single || img?.getAttribute('src') || 'https://placehold.co/600x400/331A12/FFCC80?text=أطباقنا+المميزة';
                if (img) img.src = first;

                if (titleTextEl) titleTextEl.textContent = (hero?.title || 'أهلاً بك في');
                const defaultSubtitle = document.getElementById('site-title')?.textContent || 'القائمة';
                if (subtitleEl) subtitleEl.textContent = (hero?.subtitle || defaultSubtitle);

                // تشغيل تلقائي
                if (heroTimer) { clearInterval(heroTimer); heroTimer = null; }
                const autoplay = !!hero?.autoplay;
                let interval = Number(hero?.intervalMs || 4000);
                if (interval > 0 && interval < 50) interval *= 1000;
                if (autoplay && images.length > 1) {
                    let idx = 0;
                    heroTimer = setInterval(() => {
                        idx = (idx + 1) % images.length;
                        if (img) img.src = images[idx];
                    }, interval);
                }
            }

            // عرض محتويات السلة
            function renderCart() {
                cartItemsContainer.innerHTML = '';
                let total = 0;

                if (cart.length === 0) {
                    cartItemsContainer.innerHTML = `<p class="text-center text-coffee/70 mt-10">سلتك فارغة.</p>`;
                } else {
                    cart.forEach(item => {
                        const cartItem = document.createElement('div');
                        cartItem.className = 'flex justify-between items-center bg-[#bb9b7c]/40 p-3 rounded-lg';
                        cartItem.innerHTML = `
                            <div class="flex items-start gap-3 flex-1 min-w-0">
                                <img src="${item.image || 'shopping-bag.png'}" alt="${item.name}" class="w-12 h-12 object-cover rounded-lg flex-shrink-0" />
                                <div class="min-w-0">
                                    <h4 class="font-bold text-coffee whitespace-normal break-words">${item.name}</h4>
                                    ${Array.isArray(item.selectedAddOns) && item.selectedAddOns.length ? `<div class="text-xs text-coffee/70 mt-1">${item.selectedAddOns.map(a=>`${a.name} (+${Number(a.price)||0} د.ع)`).join(' • ')}</div>` : ''}
                                    <div class="mt-1 flex items-center gap-3 flex-wrap">
                                        <span class="text-coffee font-semibold">${item.price} د.ع</span>
                                        <div class="flex items-center gap-2">
                                            <button data-id="${item.id}" class="cart-quantity-change" data-change="-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-coffee/70 hover:text-accent"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                                            </button>
                                            <span class="font-bold text-coffee w-6 text-center">${item.quantity}</span>
                                            <button data-id="${item.id}" class="cart-quantity-change" data-change="1">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-coffee/70 hover:text-accent"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <button data-id="${item.id}" class="cart-remove-item p-2 rounded-md hover:bg-red-50" aria-label="حذف" title="حذف">
                                    <img src="delete.png" alt="حذف" class="w-6 h-6 object-contain" draggable="false" />
                                </button>
                            </div>
                        `;
                        cartItemsContainer.appendChild(cartItem);
                        total += item.price * item.quantity;
                    });
                }
                cartTotalEl.textContent = `${total} د.ع`;
                updateCartCount();
                
                // إضافة المستمعات لأزرار السلة
                cartItemsContainer.querySelectorAll('.cart-quantity-change').forEach(btn => {
                    btn.addEventListener('click', () => updateCartQuantity(btn.dataset.id, parseInt(btn.dataset.change)));
                });
                cartItemsContainer.querySelectorAll('.cart-remove-item').forEach(btn => {
                    btn.addEventListener('click', () => removeFromCart(btn.dataset.id));
                });

                // نموذج بيانات الزبون داخل منطقة السلة (قابل للتمرير)
                const formDiv = document.createElement('div');
                formDiv.className = 'mt-4 space-y-3 border-t border-coffee/20 pt-4';
                formDiv.innerHTML = `
                    <div class="space-y-1">
                        <label class="block text-coffee font-semibold">ملاحظة الزبون</label>
                        <textarea id="customer-note" rows="3" class="w-full border rounded-lg px-3 py-2"></textarea>
                    </div>
                    <div class="space-y-1">
                        <label class="block text-coffee font-semibold">الاسم</label>
                        <input id="customer-name" type="text" class="w-full border rounded-lg px-3 py-2" />
                    </div>
                    <div class="space-y-1">
                        <label class="block text-coffee font-semibold">الرقم</label>
                        <input id="customer-phone" type="tel" class="w-full border rounded-lg px-3 py-2" />
                    </div>
                    <div class="space-y-1">
                        <label class="block text-coffee font-semibold">العنوان</label>
                        <input id="customer-address" type="text" class="w-full border rounded-lg px-3 py-2" required />
                    </div>
                    <div>
                        <label class="block text-coffee font-semibold mb-1">عملية الدفع</label>
                        <select id="payment-method" class="w-full border rounded-lg px-3 py-2">
                            <option value="cash" selected>نقد</option>
                        </select>
                    </div>
                `;
                cartItemsContainer.appendChild(formDiv);
                updateCartItemsHeight();
            }

            // تحديث عداد السلة
            function updateCartCount() {
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                if (totalItems > 0) {
                    cartCountBubble.textContent = totalItems;
                    cartCountBubble.classList.remove('hidden');
                } else {
                    cartCountBubble.classList.add('hidden');
                }
            }

            // --- دوال التحكم ---

            function getOrderInfo() {
                const note = (document.getElementById('customer-note')?.value || '').trim();
                const name = (document.getElementById('customer-name')?.value || '').trim();
                const phone = (document.getElementById('customer-phone')?.value || '').trim();
                const address = (document.getElementById('customer-address')?.value || '').trim();
                const payment = (document.getElementById('payment-method')?.value || 'cash');
                return { note, name, phone, address, payment };
            }

            // إرسال مخفي وسريع إلى Google Sheets (عبر Web App)
            const SHEETS_ENDPOINT_DEFAULT = 'https://script.google.com/macros/s/AKfycbwb7zlwe1mI19ivolNcw0R6NaziPc2sBivH5oFEyi48lopwBvd407KucfSVvAm26re6/exec';
            function getSheetsEndpoint() {
                try {
                    return (settings && settings.sheetsWebhookUrl) || SHEETS_ENDPOINT_DEFAULT;
                } catch {
                    return SHEETS_ENDPOINT_DEFAULT;
                }
            }

            function sendOrderToSheetsSilent(payload) {
                const url = getSheetsEndpoint();
                if (!url) return; // إذا لم يُضبط الرابط، نتجاهل بدون تعطيل التجربة
                const data = JSON.stringify(payload || {});
                // نحاول أولًا باستخدام sendBeacon ليضمن الإرسال حتى عند تبديل الصفحة
                try {
                    if (typeof navigator.sendBeacon === 'function') {
                        const blob = new Blob([data], { type: 'text/plain;charset=utf-8' });
                        navigator.sendBeacon(url, blob);
                        return; // لا حاجة لمحاولة fetch إذا نجح sendBeacon
                    }
                } catch {}
                // بديل fetch مع no-cors و keepalive
                try {
                    fetch(url, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: data,
                        keepalive: true,
                    }).catch(() => {});
                } catch (e) { /* إرسال صامت */ }
            }

            function buildOrderMessage(info) {
                // منسق أرقام عربي بدون كسور
                const NF = new Intl.NumberFormat('ar', { maximumFractionDigits: 0 });
                const fmtNum = n => NF.format(Math.round(Number(n) || 0));
                const fmtPrice = n => `${fmtNum(n)} د.ع`;
                const toArabicDigits = s => String(s || '').replace(/[0-9]/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);

                const lines = [];
                lines.push('*فاتورة الطلب*');
                lines.push('*الأصناف:*');
                let total = 0;

                if (!cart.length) {
                    lines.push('- لا توجد أصناف.');
                } else {
                    cart.forEach(it => {
                        const qty = fmtNum(it.quantity);
                        const price = fmtPrice((Number(it.price) || 0) * (Number(it.quantity) || 0));
                        lines.push(`- *${it.name}* x ${qty} — *${price}*`);
                        total += (Number(it.price) || 0) * (Number(it.quantity) || 0);
                    });
                }

                lines.push(`*المجموع:* *${fmtPrice(total)}*`);
                lines.push(`*الاسم:* ${info.name ? `*${info.name}*` : ''}`);
                lines.push(`*الرقم:* ${info.phone ? `*${toArabicDigits(info.phone)}*` : ''}`);
                lines.push(`*العنوان:* ${info.address ? `*${info.address}*` : ''}`);
                if (info.note) lines.push(`*ملاحظة:* ${info.note}`);

                return lines.join('\n');
            }

            function submitOrder() {
                if (!cart.length) {
                    showAppAlert('السلة فارغة. يرجى إضافة عناصر أولاً.', 'warning');
                    return;
                }
                const info = getOrderInfo();
                // نكتفي بالاسم والرقم ليتم الإرسال إلى Google Sheets
                if (!info.name || !info.phone) {
                    showAppAlert('يرجى إدخال الاسم والرقم لإتمام الطلب.', 'warning');
                    return;
                }
                // جهّز رسالة الطلب وافتح واتساب فورًا أولًا
                const message = buildOrderMessage(info);
                const waNum = (settings.whatsappNumber || '').replace(/[^0-9]/g, '');
                if (waNum) {
                    const url = `https://wa.me/${waNum}?text=${encodeURIComponent(message)}`;
                    window.open(url, '_blank');
                } else {
                    showAppAlert('تم تجهيز الطلب. لا يوجد رقم واتساب في الإعدادات ليتم الإرسال المباشر.', 'info');
                    console.log(message);
                }

                // إرسال Google Sheets لاحقًا بصمت وبعد فتح الواتساب لضمان عدم التأثير
                try {
                    const orderTotal = cart.reduce((sum, it) => sum + (Number(it.price) || 0) * (Number(it.quantity) || 0), 0);
                    const itemsSig = cart.map(it => `${it.id}:${it.quantity}`).join('|');
                    const orderKey = `${(info.name||'').trim()}|${(info.phone||'').trim()}|${Math.round(orderTotal||0)}|${itemsSig}`;
                    const prevKey = (()=>{ try { return sessionStorage.getItem('last_order_key')||''; } catch { return ''; } })();
                    const payload = {
                        name: info.name,
                        phone: info.phone,
                        total: Math.round(orderTotal || 0),
                        timestamp: new Date().toISOString(),
                        id: orderKey
                    };
                    if (prevKey !== orderKey) {
                        try { sessionStorage.setItem('last_order_key', orderKey); } catch {}
                        setTimeout(() => { try { sendOrderToSheetsSilent(payload); } catch {} }, 0);
                    }
                } catch {}
            }

            function updateCallLink() {
                const cNum = (settings.contactNumber || '').trim();
                if (callOrderBtn) {
                    if (cNum) {
                        const tel = 'tel:' + cNum.replace(/[^0-9+]/g, '');
                        callOrderBtn.setAttribute('href', tel);
                    } else {
                        callOrderBtn.setAttribute('href', '#');
                    }
                }
            }

            function updateSocialLinks() {
                const ig = (settings.instagramLink || '').trim();
                const fb = (settings.facebookLink || '').trim();
                const igBtn = document.getElementById('instagram-btn');
                const fbBtn = document.getElementById('facebook-btn');
                if (igBtn) igBtn.setAttribute('href', ig || 'https://www.instagram.com/diet.city_/');
                if (fbBtn) fbBtn.setAttribute('href', fb || 'https://facebook.com/');
            }

            function updateCartItemsHeight() {
                try {
                    const header = document.getElementById('cart-header');
                    const footer = document.getElementById('cart-footer');
                    const drawerH = cartDrawer ? cartDrawer.clientHeight : window.innerHeight;
                    const hH = header ? header.offsetHeight : 0;
                    const fH = footer ? footer.offsetHeight : 0;
                    const h = Math.max(0, drawerH - hH - fH);
                    cartItemsContainer.style.height = h + 'px';
                } catch {}
            }

            // تغيير القسم
            function changeCategory(category) {
                currentCategory = category;
                renderCategories(); // لإعادة تلوين الزر النشط
                renderMenuItems(category);

                // تمرير زر القسم النشط ليظهر على اليمين مع نفس الهامش
                const activeBtn = categoriesNav.querySelector(`[data-category="${category}"]`);
                if (activeBtn) {
                    const styles = getComputedStyle(categoriesNav);
                    const pr = parseFloat(styles.paddingRight) || 0; // يمين الحاوية
                    // جعل الزر يظهر عند نهاية (يمين) الحاوية ثم نضبط الإزاحة للهامش
                    activeBtn.scrollIntoView({ behavior: 'smooth', inline: 'end', block: 'nearest' });
                    const targetRight = activeBtn.offsetLeft + activeBtn.offsetWidth; // نهاية العنصر بالنسبة للحاوية
                    const desired = targetRight - categoriesNav.clientWidth + pr; // محافظاً على هامش يمين الحاوية
                    categoriesNav.scrollTo({ left: desired, behavior: 'smooth' });
                }
            }

            // فتح/إغلاق السلة
            function toggleCart(show) {
                if (show) {
                    cartModal.classList.remove('hidden');
                    setTimeout(() => {
                        cartDrawer.classList.remove('translate-x-full');
                        setTimeout(updateCartItemsHeight, 30);
                    }, 10); // تأخير بسيط لبدء التحريك
                } else {
                    cartDrawer.classList.add('translate-x-full');
                    setTimeout(() => {
                        cartModal.classList.add('hidden');
                    }, 300); // إخفاء بعد انتهاء التحريك
                }
            }

            // معاينة المنتج
            function openItemPreview(item) {
                window.previewItem = item;
                if (itemPreviewImage) itemPreviewImage.src = item.image || 'https://placehold.co/600x400/EEE/333?text=No+Image';
                if (itemPreviewName) itemPreviewName.textContent = item.name || '';
                if (itemPreviewDescription) itemPreviewDescription.textContent = item.description || '';
                buildPreviewAddons(item);
                updatePreviewPrice(item);
                itemModal.classList.remove('hidden');
            }
            function closeItemPreview() {
                itemModal.classList.add('hidden');
                window.previewItem = null;
            }

            // تأثير بصري عند إضافة المنتج (تحويل + إلى ✓ مؤقتًا دون تغيير اللون)
            function flashAddFeedback(btn) {
                if (!btn) return;
                const originalHTML = btn.innerHTML;
                try {
                    btn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                        </svg>
                    `;
                } catch {}
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                }, 900);
            }

            // إظهار رسالة "تم إضافته للسلة" داخل زر المعاينة مؤقتًا
            function flashPreviewAdded(btn) {
                if (!btn) return;
                const originalHTML = btn.innerHTML;
                const originalDisabled = btn.disabled;
                try {
                    btn.disabled = true;
                    btn.innerHTML = 'تم إضافته للسلة';
                } catch {}
                setTimeout(() => {
                    btn.disabled = originalDisabled;
                    btn.innerHTML = originalHTML;
                }, 1200);
            }

            // إضافة للسلة
            function addToCart(item) {
                const existingItem = cart.find(cartItem => cartItem.id === item.id);
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    cart.push({ ...item, quantity: 1 });
                }
                renderCart();
            }

            function buildPreviewAddons(item){
                const list = Array.isArray(item?.addOns) ? item.addOns.filter(x=> x && x.name) : [];
                if (!itemAddonsSection || !itemAddonsChoices) return;
                itemAddonsSection.classList.toggle('hidden', list.length===0);
                if (!list.length) { itemAddonsChoices.innerHTML=''; return; }
                itemAddonsChoices.innerHTML = list.map((a,i)=>`<label class="inline-flex items-center gap-2 border rounded-full px-3 py-1 text-sm"><input type="checkbox" data-idx="${i}" ${a.default?'checked':''}/> <span>${a.name}</span> <span class="text-coffee/70">(+${Number(a.price)||0} د.ع)</span></label>`).join('');
                itemAddonsChoices.querySelectorAll('input[type="checkbox"][data-idx]').forEach(cb=>{
                    cb.addEventListener('change', ()=> updatePreviewPrice(item));
                });
            }

            function getSelectedAddOns(){
                if (!itemAddonsChoices) return [];
                const cbs = Array.from(itemAddonsChoices.querySelectorAll('input[type="checkbox"][data-idx]'));
                const list = Array.isArray(window.previewItem?.addOns) ? window.previewItem.addOns : [];
                return cbs.filter(cb=> cb.checked).map(cb=> list[Number(cb.getAttribute('data-idx'))]).filter(Boolean);
            }

            function updatePreviewPrice(item){
                const base = Number(item?.price)||0;
                const selected = getSelectedAddOns();
                const extra = selected.reduce((s,a)=> s + (Number(a.price)||0), 0);
                if (itemPreviewPrice) itemPreviewPrice.textContent = `${base + extra} د.ع`;
            }

            // تحديث كمية المنتج
            function updateCartQuantity(itemId, change) {
                const item = cart.find(cartItem => cartItem.id == itemId);
                if (item) {
                    item.quantity += change;
                    if (item.quantity <= 0) {
                        removeFromCart(itemId);
                    } else {
                        renderCart();
                    }
                }
            }

            // إزالة من السلة
            function removeFromCart(itemId) {
                cart = cart.filter(cartItem => cartItem.id != itemId);
                renderCart();
            }

            // --- تشغيل التطبيق ---
            
            // إضافة مستمعي الأحداث الرئيسية
            openCartBtn.addEventListener('click', () => toggleCart(true));
            closeCartBtn.addEventListener('click', () => toggleCart(false));
            cartModal.addEventListener('click', (e) => {
                // إغلاق عند الضغط على الخلفية
                if (e.target === cartModal) {
                    toggleCart(false);
                }
            });

            // مستمعات معاينة المنتج
            closeItemBtn.addEventListener('click', closeItemPreview);
            itemModal.addEventListener('click', (e) => { if (e.target === itemModal) closeItemPreview(); });
            itemPreviewAdd.addEventListener('click', () => {
                if (window.previewItem) {
                    const base = Number(window.previewItem.price) || 0;
                    const selected = getSelectedAddOns();
                    const extra = selected.reduce((s,a)=> s + (Number(a.price)||0), 0);
                    const idSig = selected.map(a=>`${a.name}:${Number(a.price)||0}`).join('|');
                    const cartItem = { ...window.previewItem, id: `${window.previewItem.id}|${idSig}`, price: base + extra, selectedAddOns: selected };
                    addToCart(cartItem);
                }
                flashPreviewAdded(itemPreviewAdd);
            });

            // العرض الأولي
            // اضافة: تحميل البيانات من السيرفر وتجهيط
            async function loadInitialData() {
                let cats = [];
                let items = [];
                // جرّب API أولاً
                try {
                    const [catsResp, menuResp] = await Promise.all([
                        fetch('/api/categories', { cache: 'no-store' }),
                        fetch('/api/menu', { cache: 'no-store' })
                    ]);
                    if (catsResp.ok) cats = await catsResp.json().catch(() => []);
                    if (menuResp.ok) items = await menuResp.json().catch(() => []);
                } catch {}
                // مسارات الأصول (Netlify) كبديل
                if (!Array.isArray(cats) || !cats.length || !Array.isArray(items) || !items.length) {
                    try {
                        const [catsResp2, menuResp2] = await Promise.all([
                            fetch('assets/categories.json', { cache: 'no-store' }),
                            fetch('assets/menu.json', { cache: 'no-store' })
                        ]);
                        if (catsResp2.ok) cats = await catsResp2.json().catch(() => []);
                        if (menuResp2.ok) items = await menuResp2.json().catch(() => []);
                    } catch (e) {
                        console.warn('تعذّر تحميل البيانات من الأصول، سيتم استخدام القيم الحالية.', e);
                    }
                }
            
                // بناء صور الفئات ديناميًا
                categoryImages = {};
                (Array.isArray(cats) ? cats : []).forEach(c => {
                    if (!c || !c.name) return;
                    categoryImages[c.name] = c.imageUrl || 'https://placehold.co/300x300/EEE/333?text=No+Image';
                });
                const catsFromFile = (Array.isArray(cats) ? cats.map(c => c && c.name).filter(n => !!n) : []);
            
                // تجميع الأصناف حسب الفئة لتتوافق مع شكل menuData
                const grouped = {};
                (Array.isArray(items) ? items : []).forEach(it => {
                    const cat = (it.category || 'أخرى').trim();
                    if (!grouped[cat]) grouped[cat] = [];
                    grouped[cat].push({
                        id: it.id,
                        type: it.type || 'product',
                        name: it.name,
                        description: it.description || '',
                        price: it.price,
                        image: it.imageUrl || '',
                        addOns: Array.isArray(it.addOns) ? it.addOns : []
                    });
                });
                menuData = grouped;
            
                // دمج الفئات من المصدرين وضبط الفئة الحالية
                const itemsCats = Object.keys(grouped);
                categoriesList = Array.from(new Set([...(catsFromFile || []), ...itemsCats]));
                if (!currentCategory) currentCategory = categoriesList[0] || Object.keys(menuData)[0] || '';
                renderCategories();
                if (currentCategory) renderMenuItems(currentCategory);
            }
            async function loadSettingsAndHero() {
                try {
                    const [sResp, hResp, aResp] = await Promise.all([
                        fetch('/api/settings', { cache: 'no-store' }),
                        fetch('/api/hero', { cache: 'no-store' }),
                        fetch('/api/announcements', { cache: 'no-store' })
                    ]);
                    settings = sResp.ok ? await sResp.json().catch(() => ({})) : {};
                    hero = hResp.ok ? await hResp.json().catch(() => ({})) : {};
                    announcements = aResp.ok ? await aResp.json().catch(() => ({})) : {};
                } catch (e) {
                    settings = {};
                    hero = {};
                    announcements = {};
                }

                // بدائل من مجلد الأصول إذا كانت فارغة
                const needSettings = !settings || Object.keys(settings).length === 0;
                const needHero = !hero || Object.keys(hero).length === 0;
                const needAnn = !announcements || Object.keys(announcements).length === 0;
                if (needSettings || needHero || needAnn) {
                    try {
                        const [sResp2, hResp2, aResp2] = await Promise.all([
                            needSettings ? fetch('assets/settings.json', { cache: 'no-store' }) : Promise.resolve({ ok: false }),
                            needHero ? fetch('assets/hero.json', { cache: 'no-store' }) : Promise.resolve({ ok: false }),
                            needAnn ? fetch('assets/announcements.json', { cache: 'no-store' }) : Promise.resolve({ ok: false })
                        ]);
                        if (sResp2.ok) settings = await sResp2.json().catch(() => settings || {});
                        if (hResp2.ok) hero = await hResp2.json().catch(() => hero || {});
                        if (aResp2.ok) announcements = await aResp2.json().catch(() => announcements || {});
                    } catch (e) {
                        console.warn('تعذّر تحميل إعدادات/هيرو/إعلانات من الأصول.', e);
                    }
                }
            }
            // العرض الأولي
            loadSettingsAndHero().finally(() => {
                 applyHeroToPage();
                 loadInitialData();
                 renderCart(); // للعرض الأولي (سلة فارغة)
                 // ربط زر إرسال الطلب وتحديث رابط الاتصال بعد تحميل الإعدادات
                 if (submitOrderBtn) submitOrderBtn.addEventListener('click', submitOrder);
                 updateCallLink();
                 updateSocialLinks();
                 updateCartItemsHeight();
                 window.addEventListener('resize', updateCartItemsHeight);
                 });
             });
    </script>
    <!-- زر السهم للأعلى: يظهر عند التمرير ويعيدك لبداية الأقسام -->
    <button id="scroll-up-btn" aria-label="العودة إلى الأقسام" class="hidden fixed bottom-20 right-4 z-[200] w-11 h-11 rounded-full bg-orange-500/70 text-white shadow-lg hover:bg-orange-500/80 backdrop-blur-sm focus:outline-none focus:ring-2 focus:ring-orange-400/50 flex items-center justify-center">
        <span class="sr-only">إلى الأقسام</span>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75 12 8.25l7.5 7.5" /></svg>
    </button>
</body>
</html>
